trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  AWS_REGION: 'us-east-1'
  AWS_ACCOUNT_ID: '341098451732'
  ECR_REPOSITORY: 'jfc-ecommerce-dev-ecr-ecommerce-api'
  IMAGE_TAG: '$(Build.BuildId)'
  
  ECS_CLUSTER_NAME: 'jfc-ecommerce-dev-cluster-api'
  ECS_SERVICE_NAME: 'jfc-ecommerce-dev-ecs-service-api-core'
  ECS_CONTAINER_NAME: 'app'

steps:
  - checkout: self

  # Comprobar AWS & Docker
  - script: |
      echo "AWS version:"
      aws --version || echo "aws cli not found"
      echo "Docker version:"
      docker --version || echo "docker not found"

      echo "Who am I in AWS?"
      aws sts get-caller-identity || echo "STS call failed"
    displayName: 'Check AWS & Docker'

  # Build & Push
  - script: |
      echo "Login to ECR..."
      aws ecr get-login-password --region $(AWS_REGION) \
        | docker login --username AWS --password-stdin $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com

      echo "Build Docker image..."
      # Cambia "." si tu backend no está en la raíz
      docker build -t $(ECR_REPOSITORY):$(IMAGE_TAG) .

      echo "Tag and push to ECR..."
      DOCKER_IMAGE_URL=$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPOSITORY):$(IMAGE_TAG)
      docker tag $(ECR_REPOSITORY):$(IMAGE_TAG) $DOCKER_IMAGE_URL
      docker push $DOCKER_IMAGE_URL

      echo "##vso[task.setvariable variable=FULL_IMAGE_URL]$DOCKER_IMAGE_URL"
      echo "Image pushed: $DOCKER_IMAGE_URL"
    displayName: 'Build & Push Docker image to ECR'
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)          # definir como secret en el pipeline
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)  # idem
      AWS_DEFAULT_REGION: $(AWS_REGION)

  # Forzar nuevo deployment en ECS
  - script: |
      echo "Updating ECS service to force new deployment..."
      aws ecs update-service \
        --cluster $(ECS_CLUSTER_NAME) \
        --service $(ECS_SERVICE_NAME) \
        --force-new-deployment \
        --region $(AWS_REGION)

      echo "ECS service update triggered."
    displayName: 'Force new ECS deployment'
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(AWS_REGION)
