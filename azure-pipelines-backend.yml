trigger:
  branches:
    include:
      - main   # Ajusta a la rama que uses

pool:
  vmImage: 'ubuntu-latest'

variables:
  # === Variables de AWS y ECR ===
  AWS_REGION: 'us-east-2'
  AWS_ACCOUNT_ID: '341098451732'
  ECR_REPOSITORY: 'tropicales-shop-dev-ecr-backend'
  IMAGE_TAG: 'dev'
  
  # === Variables de ECS (deben coincidir con Terraform) ===
  ECS_CLUSTER_NAME: 'tropicales-shop-dev-ecs-cluster'
  ECS_SERVICE_NAME: 'tropicales-shop-dev-ecs-service-backend'
  ECS_CONTAINER_NAME: 'backend'   # nombre del contenedor en la task definition

steps:
  - checkout: self

  # --- Fase 1: Verificar AWS CLI / Docker ---
  - script: |
      echo "AWS version:"
      aws --version
      echo "Docker version:"
      docker --version
    displayName: 'Check AWS & Docker'

  # --- Fase 2: Build y push a ECR ---
  - script: |
      echo "Login to ECR..."
      aws ecr get-login-password --region $(AWS_REGION) \
        | docker login --username AWS --password-stdin $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com

      echo "Build Docker image..."
      # Si el backend está en carpeta ./backend, cambia el último punto por ./backend
      docker build -t $(ECR_REPOSITORY):$(IMAGE_TAG) .

      echo "Tag and push to ECR..."
      DOCKER_IMAGE_URL=$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPOSITORY):$(IMAGE_TAG)
      docker tag $(ECR_REPOSITORY):$(IMAGE_TAG) $DOCKER_IMAGE_URL
      docker push $DOCKER_IMAGE_URL

      echo "##vso[task.setvariable variable=FULL_IMAGE_URL]$DOCKER_IMAGE_URL"
      echo "Image pushed: $DOCKER_IMAGE_URL"
    displayName: 'Build & Push Docker image to ECR'
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(AWS_REGION)

  # --- Fase 3: Actualizar servicio ECS con la nueva imagen ---
  - task: AmazonWebServices.aws-vsts-tools.ecs-deploy-task.ECSDeployTask@1
    displayName: 'Deploy to AWS ECS'
    inputs:
      awsCredentials: 'aws-tropicales-dev'   # nombre de la Service Connection AWS
      regionName: $(AWS_REGION)
      cluster: $(ECS_CLUSTER_NAME)
      service: $(ECS_SERVICE_NAME)
      imageSource: 'imageName'
      imageName: |
        [
          {
            "name": "$(ECS_CONTAINER_NAME)",
            "imageUri": "$(FULL_IMAGE_URL)"
          }
        ]
